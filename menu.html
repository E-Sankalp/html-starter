<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sankalp Admin Panel</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <!-- LEAFLET (FREE MAP API) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: #eef1f7;
        }

        #map {
            width: 100%;
            height: 520px;
            border-radius: 16px;
        }

        /* Blinking marker (blue dot) */
        .blink-icon {
            width: 16px;
            height: 16px;
            background: #3182ce;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(0,0,255,0.6);
            animation: blink 1.2s infinite;
        }
        @keyframes blink {
            0%   { transform: scale(0.8); opacity: 0.6; }
            50%  { transform: scale(1.3); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.6; }
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 22px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.15);
            margin-bottom: 18px;
        }
    </style>
</head>

<body class="p-5">

    <h2 class="text-3xl font-bold mb-6 text-purple-700">Admin Dashboard</h2>

    <!-- DOWNLOAD BUTTONS AT TOP -->
    <div class="card mb-6">
        <h3 class="text-xl font-bold text-purple-700 mb-4">Download Logs</h3>

        <button
            onclick="downloadPunchLog()"
            class="bg-purple-600 text-white px-5 py-3 rounded-lg shadow-md hover:bg-purple-700 transition mr-4"
        >
            ðŸ“¥ Download Punch Log (Excel)
        </button>

        <button
            onclick="downloadActivityLog()"
            class="bg-purple-600 text-white px-5 py-3 rounded-lg shadow-md hover:bg-purple-700 transition"
        >
            ðŸ“¥ Download Activity Log (Excel)
        </button>
    </div>

    <!-- MAP AREA -->
    <div class="card">
        <h3 class="text-xl font-bold text-purple-700 mb-4">Live User Locations</h3>
        <div id="map"></div>
    </div>

    <!-- ACTIVITY TABLE -->
    <div class="card">
        <h3 class="text-xl font-bold text-purple-700 mb-4">User Activities</h3>

        <div class="overflow-auto">
            <table class="w-full border border-gray-300 rounded-lg">
                <thead class="bg-purple-100">
                    <tr>
                        <th class="p-2 border">Code</th>
                        <th class="p-2 border">Name</th>
                        <th class="p-2 border">Time</th>
                        <th class="p-2 border">Activity</th>
                        <th class="p-2 border">Location</th>
                    </tr>
                </thead>
                <tbody id="activityTable"></tbody>
            </table>
        </div>
    </div>

<script>

// SAME BACKEND URL
const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzrx-pZbNBDr-aRXJpcPibzm_KQlRO47UfzJfirNLRy4pdebwJz3Eu3OVnEkCb4FU2F1g/exec";

/* -----------------------------------
   INIT FREE MAP (Leaflet + OSM)
----------------------------------- */
let map = L.map("map").setView([22.97, 78.65], 6);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
}).addTo(map);

/* -----------------------------------
   LOAD USER LAST LOCATIONS (FREE MAP)
----------------------------------- */
function loadUserLocations() {
    fetch(APPS_SCRIPT_WEB_APP_URL + "?action=getAllLastLocations")
        .then(res => res.json())
        .then(data => {
            data.forEach(user => {
                if (!user.lat || !user.lon) return;

                // blinking custom HTML icon
                const iconHtml = L.divIcon({
                    html: '<div class="blink-icon"></div>',
                    className: '',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10],
                });

                L.marker([user.lat, user.lon], {
                    icon: iconHtml
                }).addTo(map)
                  .bindPopup(`<b>${user.code}</b><br>${user.name}`);
            });
        });
}

/* -----------------------------------
   LOAD ACTIVITY TABLE
----------------------------------- */
function loadActivityLogs() {
    fetch(APPS_SCRIPT_WEB_APP_URL + "?action=getAdminActivity")
        .then(res => res.json())
        .then(rows => {
            let html = "";
            rows.forEach(r => {
                html += `
                <tr>
                    <td class="border p-1">${r.code}</td>
                    <td class="border p-1">${r.name}</td>
                    <td class="border p-1">${r.time}</td>
                    <td class="border p-1">${r.activity}</td>
                    <td class="border p-1">${r.location}</td>
                </tr>`;
            });
            document.getElementById("activityTable").innerHTML = html;
        });
}

/* -----------------------------------
   DOWNLOAD FUNCTIONS
----------------------------------- */
function downloadPunchLog() {
    window.open(APPS_SCRIPT_WEB_APP_URL + "?action=downloadPunchLog", "_blank");
}

function downloadActivityLog() {
    window.open(APPS_SCRIPT_WEB_APP_URL + "?action=downloadActivityLog", "_blank");
}

/* -----------------------------------
   CALL LOAD FUNCTIONS
----------------------------------- */
loadUserLocations();
loadActivityLogs();

</script>

</body>
</html>

