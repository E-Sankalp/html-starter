<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sankalp Admin Panel</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <!-- LEAFLET (FREE MAP API) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: #eef1f7;
        }

        #map {
            width: 100%;
            height: 520px;
            border-radius: 16px;
        }

        /* Blinking BLUE icon */
        .blink-icon {
            width: 16px;
            height: 16px;
            background: #3182ce;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(0,0,255,0.6);
            animation: blink 1.2s infinite;
        }
        @keyframes blink {
            0%   { transform: scale(0.8); opacity: 0.6; }
            50%  { transform: scale(1.3); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.6; }
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 22px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.15);
            margin-bottom: 18px;
        }
    </style>
</head>

<body class="p-5">

    <h2 class="text-3xl font-bold mb-6 text-purple-700">Admin Dashboard</h2>

    <!-- DOWNLOAD BUTTONS -->
    <div class="card mb-6">
        <h3 class="text-xl font-bold text-purple-700 mb-4">Download Logs</h3>

        <button onclick="downloadPunchLog()" class="bg-purple-600 text-white px-5 py-3 rounded-lg shadow-md hover:bg-purple-700 transition mr-4">
            üì• Download Punch Log (Excel)
        </button>

        <button onclick="downloadActivityLog()" class="bg-purple-600 text-white px-5 py-3 rounded-lg shadow-md hover:bg-purple-700 transition">
            üì• Download Activity Log (Excel)
        </button>
    </div>


    <!-- =================================================================
             NEW DASHBOARD MODULE
    ================================================================== -->
    <div class="card mb-6">
        <h3 class="text-2xl font-bold text-purple-700 mb-4">Activity Dashboard</h3>

        <!-- Filters -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">

            <div>
                <label class="font-semibold text-gray-700">From Date</label>
                <input type="date" id="filterFromDate"
                    class="w-full mt-1 p-2 border rounded-lg" />
            </div>

            <div>
                <label class="font-semibold text-gray-700">To Date</label>
                <input type="date" id="filterToDate"
                    class="w-full mt-1 p-2 border rounded-lg" />
            </div>

            <div>
                <label class="font-semibold text-gray-700">Employee</label>
                <select id="filterEmployee" class="w-full mt-1 p-2 border rounded-lg">
                    <option value="">All Employees</option>
                </select>
            </div>

        </div>

        <button onclick="loadDashboardData()"
            class="bg-purple-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-purple-700 transition mb-6">
            üîç Apply Filters
        </button>

        <!-- Cards -->
        <div id="dashboardCards" class="grid grid-cols-1 md:grid-cols-5 gap-4"></div>

        <!-- Detail Table -->
        <div id="dashboardDetailPanel" class="hidden mt-6">
            <h3 class="text-xl font-bold text-purple-700 mb-4">Detailed Activity Data</h3>

            <button onclick="downloadFilteredData()"
                class="mb-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700">
                ‚¨á Download Filtered Data
            </button>

            <div class="overflow-auto">
                <table class="w-full border border-gray-300 rounded-lg">
                    <thead class="bg-purple-100">
                        <tr>
                            <th class="p-2 border">Date</th>
                            <th class="p-2 border">Code</th>
                            <th class="p-2 border">Name</th>
                            <th class="p-2 border">Time</th>
                            <th class="p-2 border">Activity</th>
                            <th class="p-2 border">Location</th>
                        </tr>
                    </thead>
                    <tbody id="dashboardDetailTable"></tbody>
                </table>
            </div>
        </div>

    </div>



    <!-- MAP -->
    <div class="card">
        <h3 class="text-xl font-bold text-purple-700 mb-4">Live User Locations</h3>
        <div id="map"></div>
    </div>


    <!-- ACTIVITY TABLE (ORIGINAL) -->
    <div class="card">
        <h3 class="text-xl font-bold text-purple-700 mb-4">User Activities</h3>

        <div class="overflow-auto">
            <table class="w-full border border-gray-300 rounded-lg">
                <thead class="bg-purple-100">
                    <tr>
                        <th class="p-2 border">Code</th>
                        <th class="p-2 border">Name</th>
                        <th class="p-2 border">Time</th>
                        <th class="p-2 border">Activity</th>
                        <th class="p-2 border">Location</th>
                    </tr>
                </thead>
                <tbody id="activityTable"></tbody>
            </table>
        </div>
    </div>




<script>
/* YOUR SAME WEB APP URL */
const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzx8hpDrQ8KlaWZrwGZUc0ajAhxYmCIdp3AV_tBD9Fq507kc78Z_OlF8C7EzhT3aPqZ/exec";



/* ============================================================
   EMPLOYEE DROPDOWN
============================================================ */
function loadEmployeeDropdown() {
    fetch(APPS_SCRIPT_WEB_APP_URL + "?action=getAllEmployees")
        .then(r => r.json())
        .then(list => {
            let html = '<option value="">All Employees</option>';
            list.forEach(e => {
                html += `<option value="${e.code}">${e.code} - ${e.name}</option>`;
            });
            document.getElementById("filterEmployee").innerHTML = html;
        });
}



/* ============================================================
   DASHBOARD FILTER ‚Üí LOAD SUMMARY
============================================================ */
function loadDashboardData() {
    const fromDate = document.getElementById("filterFromDate").value;
    const toDate = document.getElementById("filterToDate").value;
    const emp = document.getElementById("filterEmployee").value;

    fetch(APPS_SCRIPT_WEB_APP_URL + `?action=getDashboardData&from=${fromDate}&to=${toDate}&emp=${emp}`)
        .then(res => res.json())
        .then(data => {
            renderDashboardCards(data.summary);
            window.dashboardFullData = data.rows;
        });
}



/* ============================================================
   SHOW COUNT CARDS
============================================================ */
function renderDashboardCards(summary) {
    let html = "";
    summary.forEach(item => {
        html += `
        <div onclick="showDetail('${item.activityType}')"
            class="cursor-pointer card p-4 text-center hover:bg-purple-50 transition border border-purple-200">

            <h3 class="text-lg font-semibold text-purple-700">${item.activityType}</h3>
            <p class="text-3xl font-bold mt-2 text-gray-900">${item.count}</p>

        </div>`;
    });
    document.getElementById("dashboardCards").innerHTML = html;
}



/* ============================================================
   SHOW DETAILED TABLE
============================================================ */
function showDetail(activityType) {
    const filtered = window.dashboardFullData.filter(x => x.activity === activityType);

    document.getElementById("dashboardDetailPanel").classList.remove("hidden");

    let html = "";
    filtered.forEach(r => {
        html += `
        <tr>
            <td class="border p-1">${r.date}</td>
            <td class="border p-1">${r.code}</td>
            <td class="border p-1">${r.name}</td>
            <td class="border p-1">${r.time}</td>
            <td class="border p-1">${r.activity}</td>
            <td class="border p-1">${r.location}</td>
        </tr>`;
    });

    document.getElementById("dashboardDetailTable").innerHTML = html;
    window.filteredDataForDownload = filtered;
}



/* ============================================================
   DOWNLOAD FILTERED CSV
============================================================ */
function downloadFilteredData() {
    const data = window.filteredDataForDownload || [];
    let csv = "Date,Code,Name,Time,Activity,Location\n";

    data.forEach(r => {
        csv += `${r.date},${r.code},${r.name},${r.time},${r.activity},${r.location}\n`;
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "FilteredActivity.csv";
    a.click();
}




/* =================================================================
   MAP INITIALIZATION (NO CHANGE)
================================================================= */
let map = L.map("map").setView([22.97, 78.65], 6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

let mapMarkers = [];  // store for clearing before refresh




/* =================================================================
      UPDATED MAP FUNCTION WITH COLORS
================================================================= */
function loadUserLocations() {

    // Clear existing markers
    mapMarkers.forEach(m => map.removeLayer(m));
    mapMarkers = [];

    fetch(APPS_SCRIPT_WEB_APP_URL + "?action=getUserWorkStatus")
        .then(res => res.json())
        .then(data => {

            data.forEach(u => {
                if (!u.lat || !u.lon) return;

                let iconHtml = "";

                if (u.status === "blue") {
                    iconHtml = L.divIcon({
                        html: '<div class="blink-icon"></div>',
                        className: '',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10],
                    });
                }

                if (u.status === "yellow") {
                    iconHtml = L.divIcon({
                        html: '<div style="width:16px;height:16px;background:#facc15;border-radius:50%;border:3px solid white;box-shadow:0 0 10px rgba(255,200,0,0.6);"></div>',
                        className: '',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10],
                    });
                }

                if (u.status === "red") {
                    iconHtml = L.divIcon({
                        html: '<div style="width:16px;height:16px;background:#ef4444;border-radius:50%;border:3px solid white;box-shadow:0 0 10px rgba(255,0,0,0.6);"></div>',
                        className: '',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10],
                    });
                }

                let marker = L.marker([u.lat, u.lon], { icon: iconHtml })
                    .addTo(map)
                    .bindPopup(`<b>${u.code}</b><br>${u.name}<br>Status: ${u.status.toUpperCase()}`);

                mapMarkers.push(marker);
            });
        });
}



/* =================================================================
      AUTO REFRESH MAP EVERY 15 MINUTES
================================================================= */
setInterval(() => {
    loadUserLocations();
}, 900000); // 900,000 ms = 15 minutes



/* =================================================================
   EXISTING FUNCTIONS
================================================================= */
function loadActivityLogs() {
    fetch(APPS_SCRIPT_WEB_APP_URL + "?action=getAdminActivity")
        .then(res => res.json())
        .then(rows => {
            let html = "";
            rows.forEach(r => {
                html += `
                <tr>
                    <td class="border p-1">${r.code}</td>
                    <td class="border p-1">${r.name}</td>
                    <td class="border p-1">${r.time}</td>
                    <td class="border p-1">${r.activity}</td>
                    <td class="border p-1">${r.location}</td>
                </tr>`;
            });
            document.getElementById("activityTable").innerHTML = html;
        });
}

function downloadPunchLog() { window.open(APPS_SCRIPT_WEB_APP_URL + "?action=downloadPunchLog", "_blank"); }
function downloadActivityLog() { window.open(APPS_SCRIPT_WEB_APP_URL + "?action=downloadActivityLog", "_blank"); }



/* INITIAL LOAD */
loadEmployeeDropdown();
loadUserLocations();
loadActivityLogs();

</script>

</body>
</html>


