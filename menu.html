<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sankalp Admin Panel</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <!-- LEAFLET (FREE MAP API) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: #eef1f7;
        }

        #map {
            width: 100%;
            height: 520px;
            border-radius: 16px;
        }

        /* Blinking marker (blue dot) */
          .blink-icon {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    position: relative;
    animation: pulse 1.6s ease-out infinite;
}

/* COLORS (same classes your JS uses) */
.red-icon {
    background: #800505;
    box-shadow: 0 0 10px rgba(255, 45, 45, 0.9);
}

.green-icon {
    background: rgb(4, 91, 40);
    box-shadow: 0 0 10px rgba(0, 200, 83, 0.9);
}

.grey-icon {
    background: #ffffff;
    box-shadow: 0 0 10px rgba(158, 158, 158, 0.8);
}

/* MODERN PULSE ANIMATION */
@keyframes pulse {
    0% {
        transform: scale(0.9);
        opacity: 0.9;
    }
    50% {
        transform: scale(1.35);
        opacity: 0.4;
    }
    100% {
        transform: scale(0.9);
        opacity: 0.9;
    }
}



        .card {
            background: white;
            border-radius: 16px;
            padding: 22px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.15);
            margin-bottom: 18px;
        }
    </style>
</head>

<body class="p-5">

    <h2 class="text-3xl font-bold mb-6 text-purple-700">Admin Dashboard</h2>

    <!-- DOWNLOAD BUTTONS AT TOP -->
    <div class="card mb-6">
        <h3 class="text-xl font-bold text-purple-700 mb-4">Download Logs</h3>

        <button
            onclick="downloadPunchLog()"
            class="bg-purple-600 text-white px-5 py-3 rounded-lg shadow-md hover:bg-purple-700 transition mr-4"
        >
            üì• Download Punch Log (Excel)
        </button>

        <button
            onclick="downloadActivityLog()"
            class="bg-purple-600 text-white px-5 py-3 rounded-lg shadow-md hover:bg-purple-700 transition"
        >
            üì• Download Activity Log (Excel)
        </button>
    </div>

    <!-- MAP AREA -->
    <div class="card">
        <h3 class="text-xl font-bold text-purple-700 mb-4">Live User Locations</h3>
        <div id="map"></div>
    </div>

    <!-- ACTIVITY TABLE -->
    <div class="card">
        <h3 class="text-xl font-bold text-purple-700 mb-4">User Activities</h3>

        <div class="overflow-auto">
            <table class="w-full border border-gray-300 rounded-lg">
                <thead class="bg-purple-100">
                    <tr>
                        <th class="p-2 border">Code</th>
                        <th class="p-2 border">Name</th>
                        <th class="p-2 border">Time</th>
                        <th class="p-2 border">Activity</th>
                        <th class="p-2 border">Location</th>
                    </tr>
                </thead>
                <tbody id="activityTable"></tbody>
            </table>
        </div>
    </div>

<script>
const correctPassword = "Sankalp@12125";  // your password

    let input = prompt("Enter Password to Access:");

    if (input !== correctPassword) {
        document.body.innerHTML = "<h2 style='color:red;text-align:center;margin-top:40px;'>Access Denied ‚ùå</h2>";
        throw new Error("Unauthorized");
    }
// SAME BACKEND URL
const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzexym-pXbQwanjKS5VjQufDFeDP4tRavZJW-LvjYqdPahv7MPfjZxK7gDFVaKyC5yDFw/exec";

/* -----------------------------------
   INIT FREE MAP (Leaflet + OSM)
----------------------------------- */
let map = L.map("map").setView([22.97, 78.65], 6);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
}).addTo(map);

/* -----------------------------------
   LOAD USER LAST LOCATIONS (FREE MAP)
----------------------------------- */
function loadUserLocations() {
    fetch(APPS_SCRIPT_WEB_APP_URL + "?action=getAllLastLocations")
        .then(res => res.json())
        .then(data => {
            data.forEach(user => {

                /* -------------------------------------------------
                   DO NOT REMOVE ‚Üí users with no punch still appear
                   but without marker
                --------------------------------------------------- */
                if (!user.lat || !user.lon) {
                    // user has not punched in ‚Üí NO MARKER
                    return;
                }

                /* -------------------------------------------------
                   NEW COLOR LOGIC (required by you)
                --------------------------------------------------- */
                let colorClass = "";

                if (user.punchedIn === false) {
                    colorClass = "grey-icon";           // NOT punched in today
                } else if (user.punchedIn === true && user.hasActivity === false) {
                    colorClass = "red-icon";            // PUNCHED IN only (no visit)
                } else if (user.hasActivity === true) {
                    colorClass = "green-icon";          // ACTIVITY done
                }

                /* -------------------------------------------------
                   Blinking custom HTML icon with color class
                --------------------------------------------------- */
                const iconHtml = L.divIcon({
                    html: `<div class="blink-icon ${colorClass}"></div>`,
                    className: '',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10],
                });

                L.marker([user.lat, user.lon], {
                    icon: iconHtml
                }).addTo(map)
                  .bindPopup(`<b>${user.code}</b><br>${user.name}`);
            });
        });
}


/* -----------------------------------
   LOAD ACTIVITY TABLE
----------------------------------- */
function loadActivityLogs() {
    fetch(APPS_SCRIPT_WEB_APP_URL + "?action=getAdminActivity")
        .then(res => res.json())
        .then(rows => {
            let html = "";
            rows.forEach(r => {
                html += `
                <tr>
                    <td class="border p-1">${r.code}</td>
                    <td class="border p-1">${r.name}</td>
                    <td class="border p-1">${r.time}</td>
                    <td class="border p-1">${r.activity}</td>
                    <td class="border p-1">${r.location}</td>
                </tr>`;
            });
            document.getElementById("activityTable").innerHTML = html;
        });
}

/* -----------------------------------
   DOWNLOAD FUNCTIONS
----------------------------------- */
function downloadPunchLog() {
    window.open(APPS_SCRIPT_WEB_APP_URL + "?action=downloadPunchLog", "_blank");
}

function downloadActivityLog() {
    window.open(APPS_SCRIPT_WEB_APP_URL + "?action=downloadActivityLog", "_blank");
}

/* -----------------------------------
   CALL LOAD FUNCTIONS
----------------------------------- */
loadUserLocations();
loadActivityLogs();

</script>

</body>
</html>

