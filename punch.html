<!DOCTYPE html>
<html>
<head>
  <title>Punch In/Out</title>
  <style>
    body { font-family: Arial; text-align: center; padding: 30px; }
    input, button { padding: 10px; margin: 10px; width: 80%; max-width: 300px; }
    button { background: #2196F3; color: white; border: none; border-radius: 5px; }
    #gps-status { font-size: 14px; color: green; }
  </style>
</head>
<body onload="getLocation()">
  <h2>ğŸ“ Punch In / Out</h2>
  <div id="gps-status">ğŸ“¡ Getting location...</div>

  <form id="punchin">
    <input type="number" name="km" placeholder="Opening KM" required><br>
    <input type="file" name="photo" accept="image/*" capture="environment" required><br>
    <button type="button" onclick="submitForm('punchin')">âœ… Punch In</button>
  </form>

  <form id="punchout">
    <input type="number" name="km" placeholder="Closing KM" required><br>
    <input type="file" name="photo" accept="image/*" capture="environment" required><br>
    <button type="button" onclick="submitForm('punchout')">ğŸ•˜ Punch Out</button>
  </form>

  <button onclick="window.location.href='?page=menu'">ğŸ”™ Back to Menu</button>

  <script>
    let currentGPS = "";
    let punchInGPS = "";

    function getLocation() {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          currentGPS = `${position.coords.latitude},${position.coords.longitude}`;
          document.getElementById('gps-status').innerText = `ğŸ“ Location Captured`;
          if (!localStorage.getItem("punchInGPS")) {
            localStorage.setItem("punchInGPS", currentGPS);
          }
        },
        () => document.getElementById('gps-status').innerText = 'âŒ Unable to get location'
      );
    }

    async function submitForm(type) {
      const form = document.getElementById(type);
      const empCode = localStorage.getItem("empCode");
      const location = currentGPS;
      const km = form.km.value;
      const photoFile = form.photo.files[0];

      if (!empCode || !location || !km || !photoFile) {
        alert("Please fill all fields and attach photo.");
        return;
      }

      const photoData = new FormData();
      photoData.append("photo", photoFile);
      photoData.append("type", type);
      photoData.append("empCode", empCode);
      photoData.append("km", km);
      photoData.append("location", location);

      const response = await fetch("https://script.google.com/macros/s/AKfycbyz_3uiEY1u-pszXKfXkRAPF_NQIk2PU0qu2eUAdKTKEWyiq4K22vwSfNtpbp0jFigMAg/exec", {
        method: "POST",
        body: photoData,
      });

      if (type === "punchout") {
        const outCoords = location.split(',').map(Number);
        const inCoords = (localStorage.getItem("punchInGPS") || "0,0").split(',').map(Number);
        const gpsKM = haversineDistance(inCoords[0], inCoords[1], outCoords[0], outCoords[1]);
        const manualKM = parseFloat(km);
        const diff = Math.abs(manualKM - gpsKM);

        alert(`ğŸ“ Manual KM: ${manualKM}\nğŸ“ GPS KM: ${gpsKM.toFixed(2)}\nğŸ§¾ Difference: ${diff.toFixed(2)} KM`);
        if (diff > 10) alert("âš ï¸ Manual and GPS KM differ significantly!");
      }

      alert("âœ… Submitted Successfully");
      form.reset();
    }

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function toRad(x) {
      return x * Math.PI / 180;
    }
  </script>
</body>
</html>
