<script>
  let punchInGPS = "";
  let currentGPS = "";

  // Get current location
  function getLocation() {
    navigator.geolocation.getCurrentPosition(pos => {
      currentGPS = `${pos.coords.latitude},${pos.coords.longitude}`;
      if (!localStorage.getItem("punchInGPS")) {
        localStorage.setItem("punchInGPS", currentGPS); // Save for Punch Out
      }
    });
  }

  async function submitForm(type) {
    const form = document.getElementById(type);
    const formData = new FormData(form);
    const empCode = localStorage.getItem("empCode");

    let location = currentGPS;
    if (type === "punchin") {
      localStorage.setItem("punchInGPS", location);
    }

    formData.append("type", type);
    formData.append("empCode", empCode);
    formData.append("location", location);

    const res = await fetch("YOUR_SCRIPT_URL", {
      method: "POST",
      body: formData,
    });

    if (type === "punchout") {
      const outCoords = currentGPS.split(",").map(Number);
      const inCoords = localStorage.getItem("punchInGPS").split(",").map(Number);
      const gpsKM = haversineDistance(inCoords[0], inCoords[1], outCoords[0], outCoords[1]);
      const manualKM = parseFloat(form.km.value);
      const diff = Math.abs(gpsKM - manualKM);

      alert(`üìç GPS KM: ${gpsKM.toFixed(2)} KM\nüìè Manual KM: ${manualKM} KM`);
      if (diff > 10) {
        alert("‚ö†Ô∏è Alert: GPS & Manual KM differ by more than 10 KM!");
      }
    } else {
      alert("Submitted");
    }

    form.reset();
  }

  function haversineDistance(lat1, lon1, lat2, lon2) {
    function toRad(x) { return x * Math.PI / 180; }
    const R = 6371;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat / 2) ** 2 +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLon / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }
</script>
