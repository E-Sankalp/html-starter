<!DOCTYPE html>
<html>
<head>
  <title>Punch In/Out</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      text-align: center;
    }
    input, button {
      padding: 10px;
      margin: 10px;
      width: 80%;
      max-width: 300px;
      font-size: 16px;
    }
    button {
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 5px;
    }
    button:hover {
      background-color: #0b7dda;
    }
    #gps-status {
      margin-bottom: 15px;
      font-size: 14px;
      color: green;
    }
  </style>
</head>
<body onload="getLocation()">
  <h2>üìç Punch In / Punch Out</h2>
  <div id="gps-status">üì° Getting location...</div>

  <form id="punchin">
    <input type="number" name="km" placeholder="Opening KM" required>
    <button type="button" onclick="submitForm('punchin')">‚úÖ Punch In</button>
  </form>

  <form id="punchout">
    <input type="number" name="km" placeholder="Closing KM" required>
    <button type="button" onclick="submitForm('punchout')">üïò Punch Out</button>
  </form>

  <button onclick="window.location.href='?page=menu'">üîô Back to Menu</button>

  <script>
    let currentGPS = "";
    let punchInGPS = "";

    function getLocation() {
      if (!navigator.geolocation) {
        document.getElementById('gps-status').innerText = '‚ùå GPS not supported';
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          currentGPS = `${lat},${lng}`;
          document.getElementById('gps-status').innerText = `üìç Location Captured`;
          if (!localStorage.getItem("punchInGPS")) {
            localStorage.setItem("punchInGPS", currentGPS);
          }
        },
        () => {
          document.getElementById('gps-status').innerText = '‚ùå Unable to retrieve location';
        }
      );
    }

    async function submitForm(type) {
      const form = document.getElementById(type);
      const empCode = localStorage.getItem("empCode");
      const location = currentGPS;
      const km = form.km.value;

      if (!empCode || !location || !km) {
        alert("‚ùó Please fill all fields and ensure GPS is available.");
        return;
      }

      const formData = new FormData();
      formData.append("type", type);
      formData.append("empCode", empCode);
      formData.append("km", km);
      formData.append("location", location);

      const response = await fetch("<?= ScriptApp.getService().getUrl() ?>", {
        method: "POST",
        body: formData,
      });

      if (type === "punchout") {
        const outCoords = location.split(',').map(Number);
        const inCoords = (localStorage.getItem("punchInGPS") || "0,0").split(',').map(Number);
        const gpsKM = haversineDistance(inCoords[0], inCoords[1], outCoords[0], outCoords[1]);
        const manualKM = parseFloat(km);
        const diff = Math.abs(manualKM - gpsKM);

        alert(`üìè Manual KM: ${manualKM}\nüìç GPS KM: ${gpsKM.toFixed(2)}\nüßæ Difference: ${diff.toFixed(2)} KM`);
        if (diff > 10) {
          alert("‚ö†Ô∏è Manual and GPS KM differ significantly!");
        }
      }

      alert("‚úÖ Submitted Successfully");
      form.reset();
    }

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // Radius of Earth in KM
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function toRad(deg) {
      return deg * Math.PI / 180;
    }
  </script>
</body>
</html>
